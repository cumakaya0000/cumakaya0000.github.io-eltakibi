<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Drag Game</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#111;
  font-family:sans-serif;
}

video{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  border-radius:10px;
  opacity:0.85;
}

#box{
  position:absolute;
  width:110px;
  height:110px;
  background:#4ade80;
  border-radius:16px;
  left:150px;
  top:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
  touch-action:none;
  color:#000;
}

#info{
  position:fixed;
  left:10px;
  top:10px;
  color:white;
  font-size:14px;
}

#score{
  position:fixed;
  right:10px;
  top:10px;
  color:white;
  font-size:18px;
}

.target{
  position:absolute;
  width:70px;
  height:70px;
  border-radius:14px;
  pointer-events:none;
}

.float{
  position:absolute;
  color:white;
  font-weight:bold;
  animation: pop 0.8s ease-out forwards;
  pointer-events:none;
}

@keyframes pop{
  from{transform:translateY(0);opacity:1;}
  to{transform:translateY(-30px);opacity:0;}
}
</style>
</head>
<body>

<div id="info">Hazır</div>
<div id="score">Puan: 0</div>
<div id="box">TUT</div>
<video id="video" autoplay playsinline muted></video>

<script type="module">

import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

const { HandLandmarker, FilesetResolver } = vision;

const video = document.getElementById("video");
const box   = document.getElementById("box");
const info  = document.getElementById("info");
const scoreDiv = document.getElementById("score");

let handLandmarker;

let grabbing = false;
let lastFinger = null;

let score = 0;
let gameOver = false;

const targets = [];

// ---------------- CAMERA ----------------
async function setupCamera(){

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{ ideal:"environment" },
      width:{ ideal:640 },
      height:{ ideal:480 }
    },
    audio:false
  });

  video.srcObject = stream;

  return new Promise(r => video.onloadedmetadata = r);
}

// ---------------- MEDIAPIPE ----------------
async function createLandmarker(){

  const fileset = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(fileset,{
    baseOptions:{
      modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode:"VIDEO",
    numHands:1
  });
}

function distance(a,b){
  const dx = a.x-b.x;
  const dy = a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}

// ---------------- TARGET SYSTEM ----------------

function spawnTarget(){

  if(gameOver) return;

  const t = document.createElement("div");
  t.className = "target";

  const good = Math.random() < 0.5;

  t.dataset.type = good ? "good" : "bad";
  t.style.background = good ? "#f472b6" : "#ef4444";

  t.style.left = Math.random() * (window.innerWidth-80) + "px";
  t.style.top  = Math.random() * (window.innerHeight-80) + "px";

  document.body.appendChild(t);
  targets.push(t);

  setTimeout(()=>{
    if(t.parentNode){
      t.remove();
      const i = targets.indexOf(t);
      if(i>-1) targets.splice(i,1);
    }
  },4000);
}

function isHit(a,b){
  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();

  return !(
    r1.right < r2.left ||
    r1.left > r2.right ||
    r1.bottom < r2.top ||
    r1.top > r2.bottom
  );
}

function showFloat(x,y,text){
  const f = document.createElement("div");
  f.className = "float";
  f.textContent = text;
  f.style.left = x+"px";
  f.style.top  = y+"px";
  document.body.appendChild(f);

  setTimeout(()=>f.remove(),800);
}

function finishGame(){
  gameOver = true;
  info.textContent = "Oyun bitti!";
}

function checkTargets(){

  if(gameOver) return;

  for(let i=targets.length-1;i>=0;i--){

    const t = targets[i];

    if(isHit(box,t)){

      const rect = t.getBoundingClientRect();

      if(t.dataset.type==="good"){
        score += 10;
        showFloat(rect.left,rect.top,"+10");
      }else{
        score -= 10;
        showFloat(rect.left,rect.top,"-10");
      }

      scoreDiv.textContent = "Puan: " + score;

      t.remove();
      targets.splice(i,1);

      if(score >= 50){
        finishGame();
      }
    }
  }
}

// ---------------- LOOP ----------------

let lastTime = -1;

async function loop(){

  if(video.readyState >= 2 && !gameOver){

    const now = performance.now();

    if(lastTime !== video.currentTime){

      lastTime = video.currentTime;

      const res = handLandmarker.detectForVideo(video, now);

      if(res.landmarks && res.landmarks.length){

        const lm = res.landmarks[0];

        const indexTip = lm[8];
        const thumbTip = lm[4];

        const pinch = distance(indexTip,thumbTip) < 0.05;

        grabbing = pinch;

        box.style.background = grabbing ? "#facc15" : "#60a5fa";

        if(grabbing){

          const x = indexTip.x * window.innerWidth;
          const y = indexTip.y * window.innerHeight;

          if(lastFinger){

            const dx = x - lastFinger.x;
            const dy = y - lastFinger.y;

            const rect = box.getBoundingClientRect();

            let newX = rect.left + dx;
            let newY = rect.top  + dy;

            box.style.left = newX + "px";
            box.style.top  = newY + "px";

            checkTargets();
          }

          lastFinger = { x, y };

          info.textContent = "Sürükleniyor";

        }else{
          lastFinger = null;
          info.textContent = "El var";
        }

      }else{
        lastFinger = null;
        info.textContent = "El yok";
        box.style.background = "#4ade80";
      }

    }
  }

  requestAnimationFrame(loop);
}

await setupCamera();
await createLandmarker();

setInterval(spawnTarget,1200);

loop();

</script>
</body>
</html>
