<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Game</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#111;
  font-family:sans-serif;
}

video{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  border-radius:10px;
  opacity:0.85;
}

#box{
  position:absolute;
  width:110px;
  height:110px;
  background:#4ade80;
  border-radius:20px;
  left:150px;
  top:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
  touch-action:none;
}

#info{
  position:fixed;
  left:10px;
  top:10px;
  color:white;
  font-size:14px;
}

#hud{
  position:fixed;
  right:10px;
  top:10px;
  color:white;
  font-size:16px;
  text-align:right;
}

.target{
  position:absolute;
  width:70px;
  height:70px;
  border-radius:14px;
  pointer-events:none;
}

.float{
  position:absolute;
  color:white;
  font-weight:bold;
  pointer-events:none;
  animation: pop .8s ease-out forwards;
}

@keyframes pop{
  from{opacity:1;transform:translateY(0);}
  to{opacity:0;transform:translateY(-30px);}
}
</style>
</head>
<body>

<div id="info">Hazır</div>
<div id="hud">
  Puan: <span id="score">0</span><br>
  Combo: <span id="combo">0</span><br>
  Süre: <span id="time">120</span>
</div>

<div id="box">TUT</div>
<video id="video" autoplay playsinline muted></video>

<script type="module">

import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

const { HandLandmarker, FilesetResolver } = vision;

const video = document.getElementById("video");
const box   = document.getElementById("box");
const info  = document.getElementById("info");

const scoreEl = document.getElementById("score");
const comboEl = document.getElementById("combo");
const timeEl  = document.getElementById("time");

let handLandmarker;

let grabbing = false;
let lastFinger = null;

// ----------------- OYUN -----------------

let score = 0;

let combo = 0;
let lastHitTime = 0;

let gameOver = false;

const GAME_TIME = 120000;
let startTime = performance.now();

const targets = [];

// ---------------- CAMERA ----------------

async function setupCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{ ideal:"environment" },
      width:{ ideal:640 },
      height:{ ideal:480 }
    },
    audio:false
  });
  video.srcObject = stream;
  return new Promise(r => video.onloadedmetadata = r);
}

// ---------------- MEDIAPIPE ----------------

async function createLandmarker(){

  const fileset = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(fileset,{
    baseOptions:{
      modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode:"VIDEO",
    numHands:1
  });
}

function distance(a,b){
  const dx = a.x-b.x;
  const dy = a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}

// ---------------- TARGET ----------------

function spawnTarget(){

  if(gameOver) return;

  const el = document.createElement("div");
  el.className = "target";

  const good = Math.random() < 0.5;

  el.dataset.type = good ? "good" : "bad";
  el.style.background = good ? "#f472b6" : "#ef4444";

  const obj = {
    el,
    x: Math.random() * (innerWidth-80),
    y: Math.random() * (innerHeight-80),
    vx: (Math.random()*0.6+0.2) * (Math.random()<0.5?-1:1),
    vy: (Math.random()*0.6+0.2) * (Math.random()<0.5?-1:1)
  };

  el.style.left = obj.x+"px";
  el.style.top  = obj.y+"px";

  document.body.appendChild(el);
  targets.push(obj);

  setTimeout(()=>{
    removeTarget(obj);
  },8000);
}

function removeTarget(t){
  const i = targets.indexOf(t);
  if(i>-1){
    t.el.remove();
    targets.splice(i,1);
  }
}

function updateTargets(){

  for(const t of targets){

    t.x += t.vx;
    t.y += t.vy;

    if(t.x<0 || t.x>innerWidth-70) t.vx*=-1;
    if(t.y<0 || t.y>innerHeight-70) t.vy*=-1;

    t.el.style.left = t.x+"px";
    t.el.style.top  = t.y+"px";
  }
}

// ---------------- HIT ----------------

function isHit(a,b){

  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();

  return !(
    r1.right < r2.left ||
    r1.left > r2.right ||
    r1.bottom < r2.top ||
    r1.top > r2.bottom
  );
}

function showFloat(x,y,text){
  const f = document.createElement("div");
  f.className = "float";
  f.textContent = text;
  f.style.left = x+"px";
  f.style.top  = y+"px";
  document.body.appendChild(f);
  setTimeout(()=>f.remove(),800);
}

function checkTargets(){

  const now = performance.now();

  for(let i=targets.length-1;i>=0;i--){

    const t = targets[i];

    if(isHit(box,t.el)){

      // combo penceresi
      if(now - lastHitTime < 1200){
        combo++;
      }else{
        combo = 1;
      }

      lastHitTime = now;

      const multiplier = 1 + (combo-1)*0.5;
      const base = t.el.dataset.type==="good" ? 10 : -10;

      const gained = Math.round(base * multiplier);

      score += gained;

      const r = t.el.getBoundingClientRect();
      showFloat(r.left,r.top,(gained>0?"+":"")+gained);

      comboEl.textContent = combo;
      scoreEl.textContent = score;

      removeTarget(t);
    }
  }
}

// ---------------- TIMER ----------------

function updateTimer(){

  const left = Math.max(0, GAME_TIME - (performance.now()-startTime));
  const sec = Math.ceil(left/1000);

  timeEl.textContent = sec;

  if(left<=0){
    finishGame();
  }
}

// ---------------- GAME OVER ----------------

function finishGame(){
  if(gameOver) return;
  gameOver = true;
  info.textContent = "Süre bitti!";
}

// ---------------- LOOP ----------------

let lastTime = -1;

async function loop(){

  if(!gameOver){

    updateTimer();
    updateTargets();

    if(video.readyState >= 2){

      const now = performance.now();

      if(lastTime !== video.currentTime){

        lastTime = video.currentTime;

        const res = handLandmarker.detectForVideo(video, now);

        if(res.landmarks && res.landmarks.length){

          const lm = res.landmarks[0];

          const indexTip = lm[8];
          const thumbTip = lm[4];

          grabbing = distance(indexTip,thumbTip) < 0.05;

          box.style.background = grabbing ? "#facc15" : "#60a5fa";

          if(grabbing){

            const x = indexTip.x * innerWidth;
            const y = indexTip.y * innerHeight;

            if(lastFinger){

              const dx = x-lastFinger.x;
              const dy = y-lastFinger.y;

              const r = box.getBoundingClientRect();

              box.style.left = (r.left + dx*0.9)+"px";
              box.style.top  = (r.top  + dy*0.9)+"px";

              checkTargets();
            }

            lastFinger = {x,y};
            info.textContent="Sürükleniyor";

          }else{
            lastFinger=null;
            info.textContent="El var";
          }

        }else{
          lastFinger=null;
          info.textContent="El yok";
          box.style.background="#4ade80";
        }
      }
    }
  }

  requestAnimationFrame(loop);
}

await setupCamera();
await createLandmarker();

setInterval(spawnTarget,1100);

loop();

</script>
</body>
</html>
