<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Hand Drag Demo – PC & Mobile</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#111;
  font-family:sans-serif;
}

video{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  border-radius:10px;
  opacity:0.85;
  z-index:10;
}

#box{
  position:absolute;
  width:110px;
  height:110px;
  background:#4ade80;
  border-radius:16px;
  left:150px;
  top:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
  touch-action:none;
  color:#111;
}

#info{
  position:fixed;
  left:10px;
  top:10px;
  color:white;
  font-size:14px;
  z-index:20;
}
</style>
</head>
<body>

<div id="info">Kamera açılıyor...</div>
<div id="box">TUT</div>
<video id="video" autoplay playsinline muted></video>

<script type="module">

import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

const { HandLandmarker, FilesetResolver } = vision;

const video = document.getElementById("video");
const box   = document.getElementById("box");
const info  = document.getElementById("info");

let handLandmarker;
let grabbing = false;

// ---------------- CAMERA (PC + MOBILE) ----------------
async function setupCamera(){

  const constraints = {
    video: {
      facingMode: { ideal: "environment" },
      width: { ideal: 640 },
      height: { ideal: 480 }
    },
    audio:false
  };

  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream;

  return new Promise(resolve => {
    video.onloadedmetadata = () => resolve();
  });
}

// ---------------- MEDIAPIPE ----------------
async function createLandmarker(){

  const fileset = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(fileset, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode: "VIDEO",
    numHands: 1
  });
}

// ---------------- UTILS ----------------
function distance(a, b){
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return Math.sqrt(dx*dx + dy*dy);
}

// ---------------- MAIN LOOP ----------------
let lastTime = -1;

async function loop(){

  if(video.readyState >= 2){

    const now = performance.now();

    if(lastTime !== video.currentTime){

      lastTime = video.currentTime;

      const result = handLandmarker.detectForVideo(video, now);

      if(result.landmarks && result.landmarks.length){

        const lm = result.landmarks[0];

        const indexTip = lm[8];
        const thumbTip = lm[4];

        const pinchDist = distance(indexTip, thumbTip);
        grabbing = pinchDist < 0.05;

        // Renkler
        // el var + pinch yok  -> mavi
        // el var + pinch var -> sarı
        box.style.background = grabbing ? "#facc15" : "#60a5fa";

        info.textContent = grabbing ? "Tutuluyor" : "El algılandı";

        if(grabbing){

          const vw = window.innerWidth;
          const vh = window.innerHeight;

          const x = indexTip.x * vw;
          const y = indexTip.y * vh;

          const rect = box.getBoundingClientRect();

          const smoothX = rect.left + (x - rect.left) * 0.3;
          const smoothY = rect.top  + (y - rect.top ) * 0.3;

          box.style.left = (smoothX - rect.width / 2) + "px";
          box.style.top  = (smoothY - rect.height / 2) + "px";
        }

      }else{

        info.textContent = "El yok";
        box.style.background = "#4ade80";
      }
    }
  }

  requestAnimationFrame(loop);
}

// ---------------- START ----------------
await setupCamera();
await createLandmarker();
loop();

</script>

</body>
</html>
