<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Drag - Delta Move</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#111;
  font-family:sans-serif;
}

video{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  border-radius:10px;
  opacity:0.85;
}

#box{
  position:absolute;
  width:110px;
  height:110px;
  background:#4ade80;
  border-radius:16px;
  left:150px;
  top:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
  touch-action:none;
}

#info{
  position:fixed;
  left:10px;
  top:10px;
  color:white;
  font-size:14px;
}
</style>
</head>
<body>

<div id="info">Hazır</div>
<div id="box">TUT</div>
<video id="video" autoplay playsinline muted></video>

<script type="module">

import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

const { HandLandmarker, FilesetResolver } = vision;

const video = document.getElementById("video");
const box   = document.getElementById("box");
const info  = document.getElementById("info");

let handLandmarker;

let grabbing = false;

// son parmak konumu
let lastFinger = null;

// ---------------- CAMERA ----------------
async function setupCamera(){

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{ ideal:"environment" },
      width:{ ideal:640 },
      height:{ ideal:480 }
    },
    audio:false
  });

  video.srcObject = stream;

  return new Promise(r => video.onloadedmetadata = r);
}

// ---------------- MEDIAPIPE ----------------
async function createLandmarker(){

  const fileset = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(fileset,{
    baseOptions:{
      modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode:"VIDEO",
    numHands:1
  });
}

function distance(a,b){
  const dx = a.x-b.x;
  const dy = a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}

// ---------------- LOOP ----------------
let lastTime = -1;

async function loop(){

  if(video.readyState >= 2){

    const now = performance.now();

    if(lastTime !== video.currentTime){

      lastTime = video.currentTime;

      const res = handLandmarker.detectForVideo(video, now);

      if(res.landmarks && res.landmarks.length){

        const lm = res.landmarks[0];

        const indexTip = lm[8];
        const thumbTip = lm[4];

        const pinch = distance(indexTip,thumbTip) < 0.05;

        grabbing = pinch;

        // renkler
        box.style.background = grabbing ? "#facc15" : "#60a5fa";

        if(grabbing){

          const x = indexTip.x * window.innerWidth;
          const y = indexTip.y * window.innerHeight;

          if(lastFinger){

            const dx = x - lastFinger.x;
            const dy = y - lastFinger.y;

            const rect = box.getBoundingClientRect();

            let newX = rect.left + dx;
            let newY = rect.top  + dy;

            box.style.left = newX + "px";
            box.style.top  = newY + "px";
          }

          lastFinger = { x, y };

          info.textContent = "Sürükleniyor";

        }else{
          lastFinger = null;
          info.textContent = "El var";
        }

      }else{
        lastFinger = null;
        info.textContent = "El yok";
        box.style.background = "#4ade80";
      }

    }
  }

  requestAnimationFrame(loop);
}

await setupCamera();
await createLandmarker();
loop();

</script>
</body>
</html>
